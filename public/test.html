<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram åª’ä½“ä¸Šä¼ å™¨ - æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .test-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background-color: #2980b9;
        }
        .test-button.success {
            background-color: #27ae60;
        }
        .test-button.error {
            background-color: #e74c3c;
        }
        .test-result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-result.success {
            border-color: #27ae60;
            background-color: #d5f4e6;
        }
        .test-result.error {
            border-color: #e74c3c;
            background-color: #fadbd8;
        }
        .file-input {
            margin: 10px 0;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success {
            background-color: #27ae60;
        }
        .status-error {
            background-color: #e74c3c;
        }
        .status-pending {
            background-color: #f39c12;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Telegram åª’ä½“ä¸Šä¼ å™¨æµ‹è¯•é¡µé¢</h1>
        
        <!-- åŸºç¡€è¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <h2>1. åŸºç¡€è¿æ¥æµ‹è¯•</h2>
            <button class="test-button" onclick="testHealth()">
                <span class="status-indicator status-pending" id="health-status"></span>
                æµ‹è¯•å¥åº·æ£€æŸ¥
            </button>
            <button class="test-button" onclick="testTelegram()">
                <span class="status-indicator status-pending" id="telegram-status"></span>
                æµ‹è¯•Telegramè¿æ¥
            </button>
            <button class="test-button" onclick="debugTelegram()">
                <span class="status-indicator status-pending" id="debug-telegram-status"></span>
                è°ƒè¯•Telegram API
            </button>
            <div id="basic-results" class="test-result" style="display: none;"></div>
        </div>

        <!-- ç¯å¢ƒå˜é‡æµ‹è¯• -->
        <div class="test-section">
            <h2>2. ç¯å¢ƒå˜é‡æµ‹è¯•</h2>
            <button class="test-button" onclick="testEnvironment()">
                <span class="status-indicator status-pending" id="env-status"></span>
                æ£€æŸ¥ç¯å¢ƒå˜é‡
            </button>
            <button class="test-button" onclick="getChatId()">
                <span class="status-indicator status-pending" id="chatid-status"></span>
                è·å–Chat ID
            </button>
            <div id="env-results" class="test-result" style="display: none;"></div>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ æµ‹è¯• -->
        <div class="test-section">
            <h2>3. æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h2>
            <div class="file-input">
                <input type="file" id="test-file" accept="image/*,video/*" />
            </div>
            <button class="test-button" onclick="testFileUpload()">
                <span class="status-indicator status-pending" id="upload-status"></span>
                æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
            </button>
            <button class="test-button" onclick="testSimpleUpload()">
                <span class="status-indicator status-pending" id="simple-status"></span>
                æµ‹è¯•ç®€åŒ–ä¸Šä¼ 
            </button>
            <button class="test-button" onclick="testUploadV2()">
                <span class="status-indicator status-pending" id="uploadv2-status"></span>
                æµ‹è¯•ä¸Šä¼ V2ï¼ˆæ— formidableï¼‰
            </button>
            <button class="test-button" onclick="testBase64Upload()">
                <span class="status-indicator status-pending" id="base64-status"></span>
                æµ‹è¯•Base64ä¸Šä¼ 
            </button>
            <button class="test-button" onclick="testWorkingUpload()">
                <span class="status-indicator status-pending" id="working-status"></span>
                æµ‹è¯•å·¥ä½œä¸Šä¼ ç«¯ç‚¹
            </button>
            <div class="progress-bar" id="upload-progress" style="display: none;">
                <div class="progress-fill" id="upload-progress-fill"></div>
            </div>
            <div id="upload-results" class="test-result" style="display: none;"></div>
        </div>

        <!-- APIç«¯ç‚¹æµ‹è¯• -->
        <div class="test-section">
            <h2>4. APIç«¯ç‚¹æµ‹è¯•</h2>
            <button class="test-button" onclick="testAllEndpoints()">
                <span class="status-indicator status-pending" id="endpoints-status"></span>
                æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹
            </button>
            <div id="endpoints-results" class="test-result" style="display: none;"></div>
        </div>

        <!-- ç½‘ç»œè¯Šæ–­ -->
        <div class="test-section">
            <h2>5. ç½‘ç»œè¯Šæ–­</h2>
            <button class="test-button" onclick="testNetwork()">
                <span class="status-indicator status-pending" id="network-status"></span>
                ç½‘ç»œè¿æ¥è¯Šæ–­
            </button>
            <div id="network-results" class="test-result" style="display: none;"></div>
        </div>

        <!-- ç»¼åˆæµ‹è¯• -->
        <div class="test-section">
            <h2>6. ç»¼åˆæµ‹è¯•</h2>
            <button class="test-button" onclick="runAllTests()">
                ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•
            </button>
            <div id="summary-results" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // æµ‹è¯•ç»“æœå­˜å‚¨
        const testResults = {};

        // å·¥å…·å‡½æ•°
        function updateStatus(elementId, status) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status-indicator status-${status}`;
            }
        }

        function showResult(containerId, content, isError = false) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.textContent = content;
            container.className = `test-result ${isError ? 'error' : 'success'}`;
        }

        function logTest(testName, result, error = null) {
            testResults[testName] = {
                success: !error,
                result: result,
                error: error,
                timestamp: new Date().toISOString()
            };
            console.log(`Test: ${testName}`, testResults[testName]);
        }

        // 1. å¥åº·æ£€æŸ¥æµ‹è¯•
        async function testHealth() {
            updateStatus('health-status', 'pending');
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateStatus('health-status', 'success');
                    logTest('health', data);
                    showResult('basic-results', `âœ… å¥åº·æ£€æŸ¥æˆåŠŸ\n${JSON.stringify(data, null, 2)}`);
                } else {
                    throw new Error(`Health check failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                updateStatus('health-status', 'error');
                logTest('health', null, error.message);
                showResult('basic-results', `âŒ å¥åº·æ£€æŸ¥å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        // 2. Telegramè¿æ¥æµ‹è¯•
        async function testTelegram() {
            updateStatus('telegram-status', 'pending');
            try {
                const response = await fetch('/api/test-telegram');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateStatus('telegram-status', 'success');
                    logTest('telegram', data);
                    showResult('basic-results', `âœ… Telegramè¿æ¥æˆåŠŸ\n${JSON.stringify(data, null, 2)}`);
                } else {
                    throw new Error(`Telegram test failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                updateStatus('telegram-status', 'error');
                logTest('telegram', null, error.message);
                showResult('basic-results', `âŒ Telegramè¿æ¥å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        // 3. ç¯å¢ƒå˜é‡æµ‹è¯•
        async function testEnvironment() {
            updateStatus('env-status', 'pending');
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const env = data.data.environment;
                    const envStatus = {
                        botToken: env.botTokenConfigured,
                        chatId: env.chatIdConfigured,
                        nodeVersion: env.nodeVersion
                    };
                    
                    if (env.botTokenConfigured && env.chatIdConfigured) {
                        updateStatus('env-status', 'success');
                        logTest('environment', envStatus);
                        showResult('env-results', `âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®\n${JSON.stringify(envStatus, null, 2)}`);
                    } else {
                        throw new Error('ç¯å¢ƒå˜é‡é…ç½®ä¸å®Œæ•´');
                    }
                } else {
                    throw new Error('æ— æ³•è·å–ç¯å¢ƒå˜é‡ä¿¡æ¯');
                }
            } catch (error) {
                updateStatus('env-status', 'error');
                logTest('environment', null, error.message);
                showResult('env-results', `âŒ ç¯å¢ƒå˜é‡æ£€æŸ¥å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        // 4. æ–‡ä»¶ä¸Šä¼ æµ‹è¯•
        async function testFileUpload() {
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('upload-results', 'âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', true);
                return;
            }

            updateStatus('upload-status', 'pending');
            document.getElementById('upload-progress').style.display = 'block';
            
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateStatus('upload-status', 'success');
                    logTest('fileUpload', data);
                    showResult('upload-results', `âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ\næ–‡ä»¶: ${file.name}\nå¤§å°: ${file.size} bytes\nç±»å‹: ${file.type}\nå“åº”: ${JSON.stringify(data, null, 2)}`);
                } else {
                    throw new Error(`Upload failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                updateStatus('upload-status', 'error');
                logTest('fileUpload', null, error.message);
                showResult('upload-results', `âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥\næ–‡ä»¶: ${file.name}\né”™è¯¯: ${error.message}`, true);
            } finally {
                document.getElementById('upload-progress').style.display = 'none';
            }
        }

        // 5. ç®€åŒ–ä¸Šä¼ æµ‹è¯•
        async function testSimpleUpload() {
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('upload-results', 'âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', true);
                return;
            }

            updateStatus('simple-status', 'pending');
            
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/simple-upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateStatus('simple-status', 'success');
                    logTest('simpleUpload', data);
                    showResult('upload-results', `âœ… ç®€åŒ–ä¸Šä¼ æµ‹è¯•æˆåŠŸ\n${JSON.stringify(data, null, 2)}`);
                } else {
                    throw new Error(`Simple upload failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                updateStatus('simple-status', 'error');
                logTest('simpleUpload', null, error.message);
                showResult('upload-results', `âŒ ç®€åŒ–ä¸Šä¼ æµ‹è¯•å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        // 6. ä¸Šä¼ V2æµ‹è¯•ï¼ˆæ— formidableï¼‰
        async function testUploadV2() {
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('upload-results', 'âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', true);
                return;
            }

            updateStatus('uploadv2-status', 'pending');
            
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload-v2', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateStatus('uploadv2-status', 'success');
                    logTest('uploadV2', data);
                    showResult('upload-results', `âœ… ä¸Šä¼ V2æµ‹è¯•æˆåŠŸï¼ˆå®é™…å‘é€åˆ°Telegramï¼‰\næ–‡ä»¶: ${file.name}\nå¤§å°: ${file.size} bytes\nç±»å‹: ${file.type}\nå“åº”: ${JSON.stringify(data, null, 2)}`);
                } else {
                    throw new Error(`Upload V2 failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                updateStatus('uploadv2-status', 'error');
                logTest('uploadV2', null, error.message);
                showResult('upload-results', `âŒ ä¸Šä¼ V2æµ‹è¯•å¤±è´¥\næ–‡ä»¶: ${file.name}\né”™è¯¯: ${error.message}`, true);
            }
        }

        // 7. Base64ä¸Šä¼ æµ‹è¯•
        async function testBase64Upload() {
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('upload-results', 'âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', true);
                return;
            }

            updateStatus('base64-status', 'pending');
            
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/test-photo-base64', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateStatus('base64-status', 'success');
                    logTest('base64Upload', data);
                    showResult('upload-results', `âœ… Base64ä¸Šä¼ æµ‹è¯•æˆåŠŸï¼ˆå®é™…å‘é€åˆ°Telegramï¼‰\næ–‡ä»¶: ${file.name}\nå¤§å°: ${file.size} bytes\nç±»å‹: ${file.type}\nå“åº”: ${JSON.stringify(data, null, 2)}`);
                } else {
                    throw new Error(`Base64 upload failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                updateStatus('base64-status', 'error');
                logTest('base64Upload', null, error.message);
                showResult('upload-results', `âŒ Base64ä¸Šä¼ æµ‹è¯•å¤±è´¥\næ–‡ä»¶: ${file.name}\né”™è¯¯: ${error.message}`, true);
            }
        }

        // 8. å·¥ä½œä¸Šä¼ ç«¯ç‚¹æµ‹è¯•
        async function testWorkingUpload() {
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('upload-results', 'âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', true);
                return;
            }

            updateStatus('working-status', 'pending');
            
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/working-upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateStatus('working-status', 'success');
                    logTest('workingUpload', data);
                    showResult('upload-results', `âœ… å·¥ä½œä¸Šä¼ ç«¯ç‚¹æµ‹è¯•æˆåŠŸï¼ˆå®é™…å‘é€åˆ°Telegramï¼‰\næ–‡ä»¶: ${file.name}\nå¤§å°: ${file.size} bytes\nç±»å‹: ${file.type}\nå“åº”: ${JSON.stringify(data, null, 2)}`);
                } else {
                    throw new Error(`Working upload failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                updateStatus('working-status', 'error');
                logTest('workingUpload', null, error.message);
                showResult('upload-results', `âŒ å·¥ä½œä¸Šä¼ ç«¯ç‚¹æµ‹è¯•å¤±è´¥\næ–‡ä»¶: ${file.name}\né”™è¯¯: ${error.message}`, true);
            }
        }

        // 6. APIç«¯ç‚¹æµ‹è¯•
        async function testAllEndpoints() {
            updateStatus('endpoints-status', 'pending');
            const endpoints = [
                '/api/health',
                '/api/test-telegram',
                '/api/simple-upload'
            ];
            
            let results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint, {
                        method: endpoint.includes('upload') ? 'POST' : 'GET'
                    });
                    
                    results.push({
                        endpoint,
                        status: response.status,
                        ok: response.ok,
                        statusText: response.statusText
                    });
                } catch (error) {
                    results.push({
                        endpoint,
                        error: error.message
                    });
                }
            }
            
            const allOk = results.every(r => r.ok || r.status < 500);
            updateStatus('endpoints-status', allOk ? 'success' : 'error');
            logTest('endpoints', results);
            showResult('endpoints-results', `APIç«¯ç‚¹æµ‹è¯•ç»“æœ:\n${JSON.stringify(results, null, 2)}`, !allOk);
        }

        // è°ƒè¯•Telegram API
        async function debugTelegram() {
            updateStatus('debug-telegram-status', 'pending');
            try {
                const response = await fetch('/api/debug-telegram', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateStatus('debug-telegram-status', 'success');
                    logTest('debugTelegram', data);
                    showResult('basic-results', `âœ… Telegram APIè°ƒè¯•æˆåŠŸ\n${JSON.stringify(data, null, 2)}`);
                } else {
                    throw new Error(`Debug Telegram failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                updateStatus('debug-telegram-status', 'error');
                logTest('debugTelegram', null, error.message);
                showResult('basic-results', `âŒ Telegram APIè°ƒè¯•å¤±è´¥\né”™è¯¯: ${error.message}`, true);
            }
        }

        // è·å–Chat ID
        async function getChatId() {
            updateStatus('chatid-status', 'pending');
            try {
                // ä½¿ç”¨æ–°çš„Bot Tokenè·å–æ›´æ–°
                const response = await fetch('https://api.telegram.org/bot8270108550:AAGLbtlytV71tukgev24olcT7qV4zuWKREw/getUpdates');
                const data = await response.json();
                
                if (response.ok && data.ok) {
                    updateStatus('chatid-status', 'success');
                    
                    let chatInfo = 'ğŸ“‹ Chat ID è·å–ç»“æœ:\n\n';
                    
                    if (data.result && data.result.length > 0) {
                        // æå–æ‰€æœ‰å”¯ä¸€çš„chatä¿¡æ¯
                        const chats = new Map();
                        
                        data.result.forEach(update => {
                            if (update.message && update.message.chat) {
                                const chat = update.message.chat;
                                chats.set(chat.id, {
                                    id: chat.id,
                                    title: chat.title || chat.first_name || 'Unknown',
                                    type: chat.type,
                                    username: chat.username || 'N/A'
                                });
                            }
                        });
                        
                        if (chats.size > 0) {
                            chatInfo += 'æ‰¾åˆ°ä»¥ä¸‹èŠå¤©:\n\n';
                            chats.forEach((chat, id) => {
                                chatInfo += `ğŸ”¹ Chat ID: ${id}\n`;
                                chatInfo += `   åç§°: ${chat.title}\n`;
                                chatInfo += `   ç±»å‹: ${chat.type}\n`;
                                chatInfo += `   ç”¨æˆ·å: ${chat.username}\n\n`;
                            });
                            
                            chatInfo += 'ğŸ’¡ ä½¿ç”¨è¯´æ˜:\n';
                            chatInfo += '- ç¾¤ç»„çš„Chat IDé€šå¸¸æ˜¯è´Ÿæ•°\n';
                            chatInfo += '- ç§èŠçš„Chat IDé€šå¸¸æ˜¯æ­£æ•°\n';
                            chatInfo += '- å¤åˆ¶å¯¹åº”çš„Chat IDåˆ°ç¯å¢ƒå˜é‡ä¸­\n';
                            
                            // è‡ªåŠ¨æµ‹è¯•å‘é€æ¶ˆæ¯åˆ°ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ç¾¤ç»„
                            const firstGroupId = Array.from(chats.keys()).find(id => id < 0);
                            if (firstGroupId) {
                                chatInfo += `\nğŸ§ª è‡ªåŠ¨æµ‹è¯•å‘é€æ¶ˆæ¯åˆ°ç¾¤ç»„ ${firstGroupId}...\n`;
                                try {
                                    const testResponse = await fetch(`https://api.telegram.org/bot8270108550:AAGLbtlytV71tukgev24olcT7qV4zuWKREw/sendMessage`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            chat_id: firstGroupId,
                                            text: `âœ… Chat ID æµ‹è¯•æˆåŠŸï¼\nç¾¤ç»„ID: ${firstGroupId}\næ—¶é—´: ${new Date().toLocaleString()}`
                                        })
                                    });
                                    const testData = await testResponse.json();
                                    if (testData.ok) {
                                        chatInfo += `âœ… æ¶ˆæ¯å‘é€æˆåŠŸï¼Message ID: ${testData.result.message_id}\n`;
                                        chatInfo += `ğŸ“ å»ºè®®ä½¿ç”¨çš„Chat ID: ${firstGroupId}\n`;
                                    } else {
                                        chatInfo += `âŒ æ¶ˆæ¯å‘é€å¤±è´¥: ${testData.description}\n`;
                                    }
                                } catch (testError) {
                                    chatInfo += `âŒ æµ‹è¯•å‘é€å¤±è´¥: ${testError.message}\n`;
                                }
                            }
                        } else {
                            chatInfo += 'âŒ æ²¡æœ‰æ‰¾åˆ°èŠå¤©è®°å½•\n';
                            chatInfo += 'è¯·ç¡®ä¿:\n';
                            chatInfo += '1. Botå·²æ·»åŠ åˆ°ç¾¤ç»„ä¸­\n';
                            chatInfo += '2. åœ¨ç¾¤ç»„ä¸­å‘é€äº†æ¶ˆæ¯\n';
                            chatInfo += '3. Bot Tokenæ­£ç¡®\n';
                        }
                    } else {
                        chatInfo += 'âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ›´æ–°\n';
                        chatInfo += 'è¯·å…ˆ:\n';
                        chatInfo += '1. å°†Botæ·»åŠ åˆ°ç¾¤ç»„\n';
                        chatInfo += '2. åœ¨ç¾¤ç»„ä¸­å‘é€ä¸€æ¡æ¶ˆæ¯\n';
                        chatInfo += '3. ç„¶åå†æ¬¡ç‚¹å‡»æ­¤æŒ‰é’®\n';
                    }
                    
                    logTest('getChatId', data);
                    showResult('env-results', chatInfo);
                } else {
                    throw new Error(`è·å–Chat IDå¤±è´¥: ${data.description || 'Unknown error'}`);
                }
            } catch (error) {
                updateStatus('chatid-status', 'error');
                logTest('getChatId', null, error.message);
                showResult('env-results', `âŒ è·å–Chat IDå¤±è´¥\né”™è¯¯: ${error.message}\n\nè¯·æ£€æŸ¥:\n1. Bot Tokenæ˜¯å¦æ­£ç¡®\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. Botæ˜¯å¦å·²æ·»åŠ åˆ°ç¾¤ç»„`, true);
            }
        }

        // 7. ç½‘ç»œè¯Šæ–­
        async function testNetwork() {
            updateStatus('network-status', 'pending');
            
            const tests = [
                {
                    name: 'Vercelå‡½æ•°å“åº”æ—¶é—´',
                    test: async () => {
                        const start = Date.now();
                        await fetch('/api/health');
                        return Date.now() - start;
                    }
                },
                {
                    name: 'Telegram APIè¿é€šæ€§',
                    test: async () => {
                        const response = await fetch('https://api.telegram.org/bot8226410562:AAFobiVhMFdsPwHqEfhMDvTz9yGiHfgAPss/getMe');
                        return response.ok;
                    }
                },
                {
                    name: 'æµè§ˆå™¨æ”¯æŒæ£€æŸ¥',
                    test: async () => {
                        return {
                            fetch: typeof fetch !== 'undefined',
                            formData: typeof FormData !== 'undefined',
                            fileAPI: typeof File !== 'undefined'
                        };
                    }
                }
            ];
            
            let results = {};
            
            for (const test of tests) {
                try {
                    results[test.name] = await test.test();
                } catch (error) {
                    results[test.name] = `Error: ${error.message}`;
                }
            }
            
            updateStatus('network-status', 'success');
            logTest('network', results);
            showResult('network-results', `ç½‘ç»œè¯Šæ–­ç»“æœ:\n${JSON.stringify(results, null, 2)}`);
        }

        // 8. è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            showResult('summary-results', 'ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...\n');
            
            const tests = [
                { name: 'å¥åº·æ£€æŸ¥', func: testHealth },
                { name: 'ç¯å¢ƒå˜é‡', func: testEnvironment },
                { name: 'Telegramè¿æ¥', func: testTelegram },
                { name: 'APIç«¯ç‚¹', func: testAllEndpoints },
                { name: 'ç½‘ç»œè¯Šæ–­', func: testNetwork }
            ];
            
            for (const test of tests) {
                showResult('summary-results', `${document.getElementById('summary-results').textContent}\næ­£åœ¨è¿è¡Œ: ${test.name}...`);
                await test.func();
                await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
            }
            
            // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
            const report = generateTestReport();
            showResult('summary-results', `ğŸ“Š æµ‹è¯•å®Œæˆ!\n\n${report}`);
        }

        // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        function generateTestReport() {
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r.success).length;
            const failed = total - passed;
            
            let report = `æµ‹è¯•æ€»ç»“:\n`;
            report += `æ€»è®¡: ${total} é¡¹æµ‹è¯•\n`;
            report += `é€šè¿‡: ${passed} é¡¹\n`;
            report += `å¤±è´¥: ${failed} é¡¹\n\n`;
            
            report += `è¯¦ç»†ç»“æœ:\n`;
            for (const [testName, result] of Object.entries(testResults)) {
                const status = result.success ? 'âœ…' : 'âŒ';
                report += `${status} ${testName}: ${result.success ? 'é€šè¿‡' : result.error}\n`;
            }
            
            if (failed > 0) {
                report += `\nğŸ”§ å»ºè®®æ£€æŸ¥:\n`;
                if (testResults.health && !testResults.health.success) {
                    report += `- æ£€æŸ¥Verceléƒ¨ç½²çŠ¶æ€\n`;
                }
                if (testResults.environment && !testResults.environment.success) {
                    report += `- æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®\n`;
                }
                if (testResults.telegram && !testResults.telegram.success) {
                    report += `- æ£€æŸ¥Telegram Boté…ç½®\n`;
                }
                if (testResults.fileUpload && !testResults.fileUpload.success) {
                    report += `- æ£€æŸ¥æ–‡ä»¶ä¸Šä¼ å¤„ç†é€»è¾‘\n`;
                }
            }
            
            return report;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('load', () => {
            console.log('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
            // è‡ªåŠ¨è¿è¡Œå¥åº·æ£€æŸ¥
            setTimeout(testHealth, 1000);
        });
    </script>
</body>
</html>